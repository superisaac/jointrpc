syntax = "proto3";

option go_package = "intf/tube";

message Empty {}

service MethodHub {
  rpc UpdateMethods(MethodsDecl) returns (UpdateMethodsResponse);
  rpc SubscribeAllMethods(Empty) returns (stream MethodsDecl);
}

message MethodsDecl {
  string entrypoint = 1;
  repeated string methods = 2;
}

message UpdateMethodsResponse {
  string res = 1;
}
    
service JSONRPCTube {
  rpc GetMethods(GetMethodsRequest) returns (GetMethodsResponse);
  //rpc SubscribeMethods(SubscribeMethodsRequest) returns (stream MethodUpdate);
  
  rpc Call(JSONRPCRequest) returns (JSONRPCResult);
  rpc Handle(stream JSONRPCResultPacket) returns (stream JSONRPCRequestPacket);
}

message GetMethodsRequest {
}

message GetMethodsResponse {
  repeated string methods = 1;
}

message SubscribeMethodsRequest {
}

message MethodUpdate {
  repeated string methods = 1;
}

message MetaRequest {
}

enum RPCProtocol {
  JSONRPC = 0;
}

message MetaResult {
  repeated RPCEntry entries = 1;
  int32 ping_interval = 3;
}

message RPCEntry {
  RPCProtocol protocol = 1;
  string name = 2;
  string help = 3;
}

message JSONRPCRequest {
  //string id = 1;  // empty id means notify
  int64 id = 1;
  string method = 2;
  string params = 3; // JSON encoded
}

message JSONRPCResult {
  //string id = 1;
  int64 id = 1;
  oneof result {
    string ok = 10;  // JSON encoded
    string error = 11;   // JSON encoded
  }  
}

message JSONRPCRequestPacket {
  oneof payload {
    MetaRequest meta_request = 1;
    JSONRPCRequest request = 2;
  }
}

message JSONRPCResultPacket {
  oneof payload {
    MetaResult meta_result = 1;
    JSONRPCResult result = 2;
  }
}


