syntax = "proto3";

option go_package = "intf/jointrpc";

service JointRPC {
  rpc Call(JSONRPCCallRequest) returns (JSONRPCCallResult);
  rpc Notify(JSONRPCNotifyRequest) returns (JSONRPCNotifyResponse);

  rpc ListMethods(ListMethodsRequest) returns (ListMethodsResponse);
  rpc ListDelegates(ListDelegatesRequest) returns (ListDelegatesResponse);
  rpc Worker(stream JointRPCUpPacket) returns (stream JointRPCDownPacket);
}

message Empty {}
message Status {
  int32 code = 1;
  string reason = 2;
}

message ClientAuth {
  string username = 1;
  string password = 2;
}

message JSONRPCEnvolope {
  string body = 1;  // json encoded rpc message
  string trace_id = 2;
}

message ListMethodsRequest {
  ClientAuth auth = 1;
}

message ListMethodsResponse {
  Status status = 1;
  repeated MethodInfo methods = 2;
}

message ListDelegatesRequest {
  ClientAuth auth = 1;
}

message ListDelegatesResponse {
  Status status = 1;
  repeated string delegates = 2;
}

message DeclareMethodsRequest {
  repeated MethodInfo methods = 3;
}

message DeclareMethodsResponse {
  Status status = 1;
}

message DeclareDelegatesRequest {
  repeated string methods = 3;
}

message DeclareDelegatesResponse {
  Status status = 1;
}

message JSONRPCCallRequest {
  ClientAuth auth = 1;
  JSONRPCEnvolope envolope = 2;
  bool  broadcast = 3;
  int32   timeout = 4;     // the seconds from expire this rpc
}


message JSONRPCCallResult {
  Status status = 1;
  JSONRPCEnvolope envolope = 2;
}

message JSONRPCNotifyRequest {
  ClientAuth  auth = 1;
  JSONRPCEnvolope envolope = 2;
  bool broadcast = 3;
}

message JSONRPCNotifyResponse {
  Status status = 1;
  string text = 2;
}

message MethodInfo {
  string name = 1;
  //MethodLocation location = 2;
  string help = 2;
  string schema_json = 3;
}

message Ping {
  string text = 1;
}

message Pong {
  string text = 1;
}

message ServerState {
  repeated MethodInfo methods = 1;
}

message ServerEcho {
  Status status = 1;
  string conn_public_id = 2;
}

message JointRPCDownPacket {
  oneof payload {
    ServerEcho echo = 1;

    Ping ping = 2;
    Pong pong = 3;

    DeclareMethodsResponse methodsResponse = 4;
    DeclareDelegatesResponse delegatesResponse = 5;

    JSONRPCEnvolope envolope = 10;
    ServerState state = 11;
  }
}

message JointRPCUpPacket {
  oneof payload {
    ClientAuth auth = 1;
    Ping ping = 2;
    Pong pong = 3;

    DeclareMethodsRequest methodsRequest = 4;
    DeclareDelegatesRequest delegatesRequest = 5;
    JSONRPCEnvolope envolope = 10;
  }
}
