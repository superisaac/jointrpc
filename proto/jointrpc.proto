syntax = "proto3";

option go_package = "intf/jointrpc";

service JointRPC {
  rpc ListMethods(ListMethodsRequest) returns (ListMethodsResponse);
  rpc ListDelegates(ListDelegatesRequest) returns (ListDelegatesResponse);
  rpc DeclareMethods(DeclareMethodsRequest) returns (DeclareMethodsResponse);

  rpc Call(JSONRPCCallRequest) returns (JSONRPCCallResult);
  rpc Notify(JSONRPCNotifyRequest) returns (JSONRPCNotifyResponse);
  rpc Handle(stream JointRPCUpPacket) returns (stream JointRPCDownPacket);

  // cluster aware RPCs
  //rpc WatchState(WatchStateRequest) returns (stream ServerState);
  rpc DeclareDelegates(DeclareDelegatesRequest) returns (DeclareDelegatesResponse);    
}

message Empty {}
message Error {
  int32 code = 1;
  string reason = 2;
}

message JSONRPCEnvolope {
  string body = 1;  // json encoded rpc message
  string trace_id = 2;
}

message ListMethodsRequest {
}

message ListMethodsResponse {
  repeated MethodInfo methods = 1;
}

message ListDelegatesRequest {
}

message ListDelegatesResponse {
  repeated string delegates = 1;
}

message DeclareMethodsRequest {
  string token = 1;  
  string conn_public_id = 2;
  repeated MethodInfo methods = 3;
}

message DeclareMethodsResponse {
  Error error = 1;
}

message WatchStateRequest {
  string cluster_token = 1;
}

message DeclareDelegatesRequest {
  string token = 1;
  string conn_public_id = 2;  
  repeated string methods = 3;
}

message DeclareDelegatesResponse {
  Error error = 1;
}

message JSONRPCCallRequest {
  JSONRPCEnvolope envolope = 1;
  bool  broadcast = 2;
}


message JSONRPCCallResult {
  JSONRPCEnvolope envolope = 1;
}

message JSONRPCNotifyRequest {
  JSONRPCEnvolope envolope = 1;
  bool broadcast = 2;
}

message JSONRPCNotifyResponse {
  string text = 1;
}

message MethodInfo {
  string name = 1;
  //MethodLocation location = 2;
  string help = 2;
  string schema_json = 3;
}

message PING {
  string text = 1;
}

message PONG {
  string text = 1;
}

message ServerState {
  repeated MethodInfo methods = 1;
}

message ServerGreeting {
  string conn_public_id = 1;
}

message JointRPCDownPacket {
  oneof payload {
    PING ping = 1;
    PONG pong = 2;
    ServerGreeting greeting = 3;
    ServerState state = 4;
    
    JSONRPCEnvolope envolope = 10;    
  }
}

message JointRPCUpPacket {
  oneof payload {
    PING ping = 1;
    PONG pong = 2;
    
    JSONRPCEnvolope envolope = 10;
  }
}
